plugins {
    id 'com.android.library'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace 'com.autobot.shell'
    compileSdk 34

    defaultConfig {
        minSdk 26
        targetSdk 34

        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }
}

dependencies {
    // Kotlin for Android
    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.20"

    // NanoHTTPD
    implementation 'org.nanohttpd:nanohttpd:2.3.1'
}

// ç”ŸæˆåŒ…å«æ‰€æœ‰ä¾èµ–çš„ Fat JARï¼Œç„¶åè½¬æ¢ä¸º DEX
task assembleFatJar(type: Jar, dependsOn: 'assembleRelease') {
    archiveBaseName.set('shell-server-fat')
    archiveVersion.set('')
    destinationDirectory.set(file("${buildDir}/outputs/fat-jar"))
    
    // è§£å‹ AAR å¹¶æå– classes.jar
    doFirst {
        def aarFile = file("${buildDir}/outputs/aar/shell-server-release.aar")
        def tempDir = file("${buildDir}/tmp/aar-extracted")
        tempDir.deleteDir()
        tempDir.mkdirs()
        
        copy {
            from zipTree(aarFile)
            into tempDir
        }
    }
    
    // åˆå¹¶æ‰€æœ‰ JARï¼ˆæˆ‘ä»¬çš„ä»£ç  + æ‰€æœ‰ä¾èµ–ï¼‰
    from {
        def tempDir = file("${buildDir}/tmp/aar-extracted")
        def classesJar = file("${tempDir}/classes.jar")
        
        // æ”¶é›†æ‰€æœ‰éœ€è¦åˆå¹¶çš„ JARï¼ˆä½¿ç”¨ Android Library çš„é…ç½®ï¼‰
        def jarsToMerge = []
        
        // æ·»åŠ è¿è¡Œæ—¶ä¾èµ–
        configurations.releaseRuntimeClasspath.each { file ->
            if (file.name.endsWith('.jar')) {
                jarsToMerge.add(zipTree(file))
            }
        }
        
        // æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„ classes.jar
        jarsToMerge.add(zipTree(classesJar))
        
        jarsToMerge
    }
    
    // æ’é™¤ç­¾åæ–‡ä»¶å’Œé‡å¤çš„ META-INF æ–‡ä»¶
    exclude 'META-INF/*.SF', 'META-INF/*.DSA', 'META-INF/*.RSA', 'META-INF/MANIFEST.MF'
    
    // å¤„ç†é‡å¤æ–‡ä»¶
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    doLast {
        println "âœ“ Fat JAR created: ${archiveFile.get().asFile.absolutePath}"
        println "  Size: ${archiveFile.get().asFile.length() / 1024} KB"
    }
}

// å°† Fat JAR è½¬æ¢ä¸º DEX
task assembleDexJar(dependsOn: 'assembleFatJar') {
    doLast {
        def fatJar = file("${buildDir}/outputs/fat-jar/shell-server-fat.jar")
        def dexOutputDir = file("${buildDir}/outputs/dex")
        def finalJar = file("${buildDir}/outputs/shell-server.jar")
        
        dexOutputDir.deleteDir()
        dexOutputDir.mkdirs()
        
        // æŸ¥æ‰¾ d8 å·¥å…·
        def androidSdkRoot = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
        if (!androidSdkRoot) {
            androidSdkRoot = System.getProperty("user.home") + "/AppData/Local/Android/Sdk"
        }
        
        def buildToolsDir = file("${androidSdkRoot}/build-tools")
        def d8Exe = null
        
        if (buildToolsDir.exists()) {
            buildToolsDir.listFiles().sort().reverse().each { version ->
                def d8Path = file("${version}/d8.bat")
                if (d8Path.exists() && !d8Exe) {
                    d8Exe = d8Path
                }
            }
        }
        
        if (!d8Exe) {
            throw new GradleException("âŒ d8 tool not found in Android SDK")
        }
        
        println "ğŸ”§ Converting Fat JAR to DEX using: ${d8Exe}"
        
        // æ‰§è¡Œ d8 è½¬æ¢
        exec {
            commandLine d8Exe, '--output', dexOutputDir.absolutePath, fatJar.absolutePath
            ignoreExitValue = false
        }
        
        // æ£€æŸ¥ç”Ÿæˆçš„ DEX æ–‡ä»¶
        def dexFile = file("${dexOutputDir}/classes.dex")
        if (!dexFile.exists()) {
            throw new GradleException("âŒ DEX file not generated")
        }
        
        println "âœ“ DEX generated: ${dexFile.absolutePath} (${dexFile.length() / 1024} KB)"
        
        // å°† DEX æ‰“åŒ…æˆ JAR
        ant.zip(destfile: finalJar) {
            fileset(dir: dexOutputDir) {
                include(name: "classes.dex")
            }
        }
        
        println "âœ“ Final DEX JAR created: ${finalJar.absolutePath}"
        println "  Size: ${finalJar.length() / 1024} KB"
    }
}

